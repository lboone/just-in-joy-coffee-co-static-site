document.addEventListener("DOMContentLoaded", function () {
  const ENV = "PROD";
  let homeSwiper, featuredDrinks, shoutOuts, socials, gallery, eventsUrl;

  if (ENV === "DEV") {
    homeSwiper = "/assets/data/home-swiper.json";
    featuredDrinks = "/assets/data/destinations.json";
    shoutOuts = "/assets/data/testimonials.json";
    socials = "/assets/data/social.json";
    gallery = "/assets/data/gallery.json";
    eventsUrl = "/assets/data/events.json";
  } else {
    homeSwiper =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/home-swipers/get/active";
    featuredDrinks =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/featured-drinks/get/active";
    shoutOuts =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/shout-outs/get/active";
    socials =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/socials/get/active";
    gallery =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/gallery/get/active";
    eventsUrl =
      "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/events/upcoming";
  }
  // Dynamically load nav links
  fetch("assets/data/nav.json")
    .then((response) => response.json())
    .then((links) => {
      const navList = document.getElementById("nav-list");
      navList.innerHTML = links
        .map(
          (link) =>
            `<li>
          <a href="${link.href}" class="nav__link${
            link.class ? " " + link.class : ""
          }">${link.label}</a>
        </li>`,
        )
        .join("");

      /*=============== SHOW MENU ===============*/
      const navMenu = document.getElementById("nav-menu"),
        navToggle = document.getElementById("nav-toggle"),
        navClose = document.getElementById("nav-close");

      /* Menu show */
      if (navToggle) {
        navToggle.addEventListener("click", () => {
          navMenu.classList.add("show-menu");
        });
      }

      /* Menu hide */
      if (navClose) {
        navClose.addEventListener("click", () => {
          navMenu.classList.remove("show-menu");
        });
      }

      /*=============== REMOVE MENU MOBILE ===============*/
      const navLink = document.querySelectorAll(".nav__link");
      const linkAction = () => {
        const navMenu = document.getElementById("nav-menu");
        // When we click on each nav__link, we remove the show-menu class
        navMenu.classList.remove("show-menu");
      };
      navLink.forEach((n) => n.addEventListener("click", linkAction));
    });

  // Dynamically load home swiper slides
  fetch(homeSwiper)
    .then((response) => response.json())
    .then((slides) => {
      if (!slides || !slides.success || slides.data.count === 0) return;
      const swiperWrapper = document.getElementById("home-swiper-wrapper");
      if (swiperWrapper) {
        swiperWrapper.innerHTML = slides.data
          .map(
            (slide) => `
              <article class="home__article swiper-slide">
                <a href="${slide.src}" data-lightbox="home" data-title="${slide.alt}">
                  <img
                    src="${slide.src}"
                    alt="${slide.alt}"
                    class="home__img"
                    loading="lazy"
                    width="${slide.width}"
                    height="${slide.height}"
                  />
                </a>
               
              </article>
            `,
          )
          .join("");
      }
      // If you initialize Swiper in JS, do it here after slides are loaded
      if (typeof Swiper !== "undefined") {
        // new Swiper(".home__swiper", {
        //   // your Swiper options here
        //   navigation: {
        //     nextEl: ".swiper-button-next",
        //     prevEl: ".swiper-button-prev",
        //   },
        //   loop: true,
        // });

        /*=============== SWIPER HOME ===============*/
        const swiperHome = new Swiper(".home__swiper", {
          loop: true,
          slidesPerView: "auto",
          grabCursor: true,
          // Navigation arrows
          navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
          },
          autoplay: {
            delay: 3000,
            disableOnInteraction: false,
          },
        });
      }
    });

  // Dynamically load destination cards
  fetch(featuredDrinks)
    .then((response) => response.json())
    .then((featuredDrinks) => {
      if (
        !featuredDrinks ||
        !featuredDrinks.success ||
        featuredDrinks.data.count === 0
      )
        return;
      const container = document.getElementById("destination-container");
      if (container) {
        container.innerHTML = featuredDrinks.data
          .map(
            (item) => `
              <article class="destination__card">
                <img
                  src="${item.img}"
                  alt="${item.alt}"
                  class="destination__img"
                  loading="lazy"
                  width="340"
                  height="340"
                />
                <div class="destination__data">
                  <h3 class="destination__subtitle">${item.subtitle}</h3>
                  <h2 class="destination__title">${item.title}</h2>
                  <div style="
                    overflow: auto;
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-end;
                    align-items: center;
                    font-family: SQ Market, SQ Market, Helvetica, Arial, sans-serif;
                  ">
                    <a target="_blank" href="${item.orderUrl}" class="button button__opa-30">
                      Order Now <i class="ri-external-link-line"></i>
                    </a>
                  </div>
                </div>
              </article>
            `,
          )
          .join("");
      }
    });

  // Dynamically load testimonial cards
  fetch(shoutOuts)
    .then((response) => response.json())
    .then((shoutOuts) => {
      if (!shoutOuts || !shoutOuts.success || shoutOuts.data.count === 0)
        return;
      const wrapper = document.getElementById("testimonial-swiper-wrapper");
      if (wrapper) {
        wrapper.innerHTML = shoutOuts.data
          .map(
            (t) => `
              <div class="testimonial__card swiper-slide">
                <h2 class="testimonial__title">${t.title}</h2>
                <p class="testimonial__description">
                  "${t.description}"
                </p>
                <div class="testimonial__profile">
                  <img src="${t.img}" alt="${t.imgAlt}" loading="lazy" width="60" height="60" />
                  <div class="testimonial__info">
                    <h3>${t.name}</h3>
                    <p>${t.location}</p>
                  </div>
                </div>
              </div>
            `,
          )
          .join("");
      }

      // If you initialize Swiper in JS, do it here after slides are loaded
      if (typeof Swiper !== "undefined") {
        /*=============== SWIPER TESTIMONIAL ===============*/
        const swiperTestimonial = new Swiper(".testimonial__swiper", {
          loop: true,
          slidesPerView: "auto",
          spaceBetween: 48,
          grabCursor: true,

          // Navigation arrows
          navigation: {
            nextEl: ".swiper-button-next",
            prevEl: ".swiper-button-prev",
          },
          autoplay: {
            delay: 5000,
            disableOnInteraction: false,
          },
        });
      }
    });

  // Dynamically load social cards
  fetch(socials)
    .then((response) => response.json())
    .then((socials) => {
      if (!socials || !socials.success || socials.data.count === 0) return;
      const container = document.getElementById("social-container");
      if (container) {
        container.innerHTML = socials.data
          .map(
            (item) => `
              <article class="social__card">
                <div class="social__embed">
                  <blockquote class="instagram-media"
                    data-instgrm-permalink="${item.permalink}"
                    data-instgrm-version="14"
                    style="background:#FFF; border:0; margin:0; padding:0; width:100%;">
                  </blockquote>
                </div>
              </article>
            `,
          )
          .join("");
        // Re-initialize Instagram embeds after dynamic insertion
        if (window.instgrm && window.instgrm.Embeds) {
          window.instgrm.Embeds.process();
        }
      }
    });

  // Dynamically load gallery cards
  fetch(gallery)
    .then((response) => response.json())
    .then((gallery) => {
      if (!gallery || !gallery.success || gallery.data.count === 0) return;
      const container = document.getElementById("gallery-container");
      if (container) {
        container.innerHTML = gallery.data
          .map(
            (item) => `
              <article class="gallery__card">
              <a href="${item.img}" data-lightbox="gallery" data-title="${item.alt}">
  <img src="${item.img}" alt="${item.alt}"  class="gallery__img"
                  loading="lazy"
                  width="500"
                  height="666"/>
</a>
                <div class="gallery__shadow" style="pointer-events:none;"></div>
                <div class="gallery__data">
                  <h3 class="gallery__subtitle">${item.subtitle}</h3>
                  <h2 class="gallery__title">${item.title}</h2>
                </div>
              </article>
            `,
          )
          .join("");
      }
    });

  // Dynamically load footer content
  fetch("assets/data/footer.json")
    .then((response) => response.json())
    .then((sections) => {
      const container = document.getElementById("footer-content");
      if (container) {
        container.innerHTML = sections
          .map((section) => {
            if (section.social) {
              // Social icons section
              return `
                <div>
                  <h3 class="footer__title">${section.title}</h3>
                  <div class="footer__social">
                    ${section.social
                      .map(
                        (s) => `
                          <a href="${s.href}" target="_blank" class="footer__social-link">
                            <i class="${s.icon}"></i>
                          </a>
                        `,
                      )
                      .join("")}
                  </div>
                </div>
              `;
            } else {
              // Regular links section
              return `
                <div>
                  <h3 class="footer__title">${section.title}</h3>
                  <ul class="footer__links">
                    ${section.links
                      .map(
                        (link) => `
                          <li>
                            <a href="${link.href}" class="footer__link"${
                              link.external ? ' target="_blank"' : ""
                            }>${link.label}</a>
                          </li>
                        `,
                      )
                      .join("")}
                  </ul>
                </div>
              `;
            }
          })
          .join("");
      }
    });
});

/*=============== CHANGE BACKGROUND HEADER ===============*/
const bgHeader = () => {
  const header = document.getElementById("header");
  this.scrollY >= 50
    ? header.classList.add("bg-header")
    : header.classList.remove("bg-header");
};
window.addEventListener("scroll", bgHeader);

/*=============== SHOW SCROLL UP ===============*/
const scrollUp = () => {
  const scrollUp = document.getElementById("scroll-up");
  // When the scroll is higher than 350 viewport height, add the show-scroll class to the a tag with the scroll-top class
  this.scrollY >= 350
    ? scrollUp.classList.add("show-scroll")
    : scrollUp.classList.remove("show-scroll");
};
window.addEventListener("scroll", scrollUp);
/*=============== SCROLL SECTIONS ACTIVE LINK ===============*/
const sections = document.querySelectorAll("section[id]");

const scrollActive = () => {
  const scrollDown = window.scrollY;

  sections.forEach((current) => {
    const sectionHeight = current.offsetHeight;
    const sectionTop = current.offsetTop - 58; // Adjusted for header height
    const sectionId = current.getAttribute("id");
    const sectionsClass = document.querySelector(
      `.nav__menu a[href*="${sectionId}"]`,
    );

    if (scrollDown > sectionTop && scrollDown <= sectionTop + sectionHeight) {
      sectionsClass.classList.add("active-link");
    } else {
      sectionsClass.classList.remove("active-link");
    }
  });
};
window.addEventListener("scroll", scrollActive);

/*=============== DARK LIGHT THEME ===============*/
const themeButton = document.getElementById("theme-button");
const darkTheme = "dark-theme";
const iconTheme = "ri-sun-fill";

// Set dark theme as default if no theme is stored
if (!localStorage.getItem("selected-theme")) {
  document.body.classList.add("dark-theme");
  themeButton.classList.add("ri-sun-fill");
}

// Previously selected topic (if user selected)
const selectedTheme = localStorage.getItem("selected-theme");
const selectedIcon = localStorage.getItem("selected-icon");

// We obtain the current theme that the interface has by validating the dark-theme class
const getCurrentTheme = () =>
  document.body.classList.contains(darkTheme) ? "dark" : "light";
const getCurrentIcon = () =>
  themeButton.classList.contains(iconTheme) ? "ri-moon-fill" : "ri-sun-fill";

// We validate if the user previously chose a topic
if (selectedTheme) {
  // If the validation is fulfilled, we ask what the issue was to know if we activated or deactivated the dark theme
  document.body.classList[selectedTheme === "dark" ? "add" : "remove"](
    darkTheme,
  );
  themeButton.classList[selectedIcon === "ri-moon-fill" ? "add" : "remove"](
    iconTheme,
  );
}

// Activate / deactivate the theme manually with the button
themeButton.addEventListener("click", () => {
  // Add or remove the dark / icon theme
  document.body.classList.toggle(darkTheme);
  themeButton.classList.toggle(iconTheme);

  // Save the current theme in the local storage
  localStorage.setItem("selected-theme", getCurrentTheme());
  localStorage.setItem("selected-icon", getCurrentIcon());
});

/*=============== SCROLL REVEAL ANIMATION ===============*/
const sr = ScrollReveal({
  origin: "top",
  distance: "60px",
  duration: 2000,
  delay: 300,
  reset: true,
});

sr.reveal(`.home__container`);
sr.reveal(`.home__title`, { delay: 600 });
sr.reveal(`.home__description`, { delay: 900 });
sr.reveal(`.home__data .button`, { delay: 1200 });

// Function to show event popup
function showEventPopup(event) {
  // Helper to format date as "Mon DD, YYYY"
  function formatMyDate(dateStr) {
    const d = new Date(dateStr);
    if (isNaN(d)) return dateStr; // fallback if invalid
    return d.toLocaleDateString("en-US", {
      month: "short",
      day: "2-digit",
      year: "numeric",
    });
  }
  function formatTime(timeStr) {
    // Split the time string into hours, minutes, and seconds
    const [hours, minutes] = timeStr.split(":").map(Number);

    // Determine AM or PM
    const period = hours >= 12 ? "PM" : "AM";

    // Convert hours to 12-hour format
    const formattedHours = hours % 12 || 12; // If hours is 0 or 12, show 12

    // Return the formatted time
    return `${formattedHours}:${minutes.toString().padStart(2, "0")} ${period}`;
  }

  const eDate = formatMyDate(event.date);
  const eStartTime = formatTime(event.starttime);
  const eEndTime = formatTime(event.endtime);
  Swal.fire({
    title: "Find Us Around Town!",
    html: `
      <h3 style="margin-bottom:1em; color:#7c4d1e;">${event.name}</h3>
      <div style="margin-bottom:1em;">
        <strong>Date & Time:</strong><br>
        ${eDate} ${eStartTime} - ${eEndTime}
      </div>
      <div style="margin-bottom:1em;">
        <strong>Location:</strong><br>
        ${event.address ? event.address + "<br>" : ""}
        ${event.city ? event.city + ", " : ""}${
          event.state ? event.state + " " : ""
        }${event.zip ? event.zip : ""}<br>
        ${event.country ? event.country : ""}
      </div>
      <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
        (event.address ? event.address + ", " : "") +
          (event.city ? event.city + ", " : "") +
          (event.state ? event.state + " " : "") +
          (event.zip ? event.zip : ""),
      )}" target="_blank" class="popup__link" >
        <i class="ri-map-pin-line" style="margin-right:0.5em;"></i><span class="popup__link__text">View on Map</span>
      </a>
    `,
    confirmButtonText: "Close",
    customClass: {
      popup: "event-popup",
      confirmButton: "button popup__button",
    },
  });
}

// Update getTodayOrNextEvent to show popup if event found
async function getTodayOrNextEvent() {
  const res = await fetch(
    "https://just-in-joy-coffee-co-vmckt7lji-lloyd-boones-projects.vercel.app/v1/events/upcoming",
  );
  //const res = await fetch("https://just-in-joy-coffee-co.com/admin-panel/api/events");
  const events = await res.json();

  if (events && events.success && events.data) {
    showEventPopup(events.data);
  } else {
    const findUsButton = document.getElementById("find-us-button");
    findUsButton.classList.add("button__disabled");
    findUsButton.setAttribute("disabled", true);
  }
}

// Call after DOMContentLoaded
getTodayOrNextEvent();
